image: docker:dind

variables:
  PROJECT: 'amplify-tooling'

  # Fortify
  FORTIFY_PROJECT: "10424"
  FORTIFY_BUILD_ID: "axway-cli"
  FORTIFY_INCLUDE: "packages/**/*.js"
  FORTIFY_EXCLUDE: "**/test/**/*.js"

  # Blackduck
  BLACKDUCK_PROJECT_NAME: "Catalog Commons - Axway CLI"
  BLACKDUCK_EXTRA_OPTIONS: "--detect.excluded.detector.types=LERNA"

  # SRM
  SRM_PROJECT_NAME: "$BLACKDUCK_PROJECT_NAME"
  SRM_PROJECT_ID: "11"

########################################
# set up custom names for the pipelines of releases and nightly schedules
########################################
  PIPELINE_NAME: "$CI_COMMIT_MESSAGE"

include:
  - project: "apigov/gitlabci"
    ref: master
    file: "/.gitlab-ci-sonar.yml"
  - project: 'scurity/gitlabci'
    ref: $SCURITY_GREEN
    file:
      - '/.gitlab-ci-fortify.yml'
      - "/.gitlab-ci-blackduck.yml"
      - "/.gitlab-ci-security.yml"

stages:
  - sonar-preview
  - sonar-publish
  - security-scans
  - security-review

sonar_preview:
  rules:
    - when: never

fortify:
  rules:
    - when: never

fetch-fortify:
  rules:
    - when: never

blackduck:
  rules:
    - when: always
  before_script:
    - apk update && apk add npm yarn
    - npm i -g lerna
    - lerna --help
    - which lerna
    - echo $PATH
    # - lerna ls --all --json